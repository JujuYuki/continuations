%% calculus model
%% normalisation \leadsto and \cong
%% proof confluence
%%%% find two names for annotation variables and actions (channels)
%%%% idea : conclusions VS actions
%%
%% define \equiv as \cong without commuting prefixes
%% define \to as \leadsto without commuting prefixes and acting under prefixes
%%%% Those actually mean remove the non \pi-friendly part
%% See if cut elimination is an emerging property of \to and \equiv in the
%% typed world (it is likely to be the case as it is)


\section{Definitions}

We first need to define the language of terms of our annotated $\pi$-calculus.
\begin{definition}
The annotated terms are defined by the following grammar:
\begin{flalign*}P,Q::= & x\tto y\;\; ; \;\; 0_x\;\; ; &\text{base terms}&\\
& \epsilon_x.P\;\; ; \;\; \lambda_xy.P\;\; ; &\text{variable introduction and modality prefixes}&\\
& u_x(t).P\;\; ; \;\; \bar{u}_x\langle v\rangle.P\;\; ; &\text{action prefixes}&\\
& P |_x Q\;\; ; \;\; P ||_x Q \;\; ; &\text{parallel and synchronization}&\\
& (\nu u) P &\text{name binding prefix}&
\end{flalign*}
\end{definition}

The synchronization rule will be used to guide the behavior of terms, thus we define a reduction system over this construction specifically, as follows:
\begin{definition}
We define a reduction rule for synchronization (that does not hold under action prefixes) as follows:
\begin{flalign*}
\epsilon_x.P||_x 0_x &\to P &\text{symmetric in }||\;\;\;1\\
P||_x x\tto y &\to P[y/x] &\text{symmetric in }||\;\;\;2\\
(P|_xQ)||_x \lambda_xy.R &\to P||_x (Q[y/x] ||_y R) &3a\\
\lambda_xy.R ||_x (P|_xQ) &\to (R||_xP)||_y Q[y/x] &3b\\
\bar{u}_x\langle v \rangle.P||_x u_x(t).Q &\to P ||_x Q[v/t] &\text{symmetric in }||\;\;\;4\\~\\
\hline\\
(P|_xQ)||_yR &\to (P||_yR)|_xQ &\text{symmetric in $||$, }y\not\in fv(Q)\;\;\;5a\\
(P|_xQ)||_yR &\to P|_x(Q||_yR) &\text{symmetric in $||$, }y\not\in fv(P)\;\;\;5b\\
\epsilon_x.P||_yQ &\to \epsilon_x.(P||_yQ) &\text{symmetric in $||$}\;\;\;6a\\
\lambda_xy.P||_zQ &\to \lambda_xy.(P||_zQ) &\text{symmetric in $||$, }y\not\in fv(Q)\;\;\;6b\\
(\nu u)P ||_x Q &\to (\nu u)(P||_xQ) &\text{symmetric in $||$, }u\not\in fn(Q)\;\;\;6c
\end{flalign*}
And we extend it into $\leadsto$ as follows, allowing for it to act under action prefixes as well:
\begin{flalign*}
u_x(t).P||_yQ &\leadsto u_x(t).(P||_yQ) &\text{symmetric in }||\;\;\;6d\\
\bar{u}_x\langle v \rangle.P||_yQ &\leadsto \bar{u}_x\langle v \rangle.(P||_yQ) &\text{symmetric in }||\;\;\;6e
\end{flalign*}
\end{definition}

We would like these arrows to have a confluent behavior. For that, we need equivalences, that we will define below.
\newpage

\begin{definition}
We define a congruence rule, that does not act on action prefixes:
\begin{flalign*}
(P|_xQ)|_yR &\equiv (P|_yR)|_xQ &y\not\in fv(Q), x\not\in fv(R)\;\;\;a_1\\
P|_x(Q|_yR) &\equiv Q|_y(P|_xR) &y\not\in fv(P), x\not\in fv(Q)\;\;\;a_2\\
(P|_xQ)|_yR &\equiv P|_x(Q|_yR) &y\not\in fv(P), x\not\in fv(R)\;\;\;b\\
P|_x \alpha_y.Q &\equiv \alpha_y.(P|_xQ) &\text{symmetric in }|, \alpha_{\cdot}\in\{\epsilon_{\cdot},\lambda_{\cdot} z\}, y,t\not\in fv(P)\;\;\;c\\
\alpha_x.\beta_y.P &\equiv \beta_y.\alpha_x.P &\alpha_{\cdot},\beta_{\cdot}\in\{\epsilon_{\cdot},\lambda_{\cdot} z\},x\neq y\;\;\;d\\
(\nu u) P |_x Q &\equiv (\nu u)(P |_x Q)&\text{symmetric in }|, u\not\in fn(Q)\;\;\;e\\
(\nu u)\alpha_x.P &\equiv \alpha_x.(\nu u)P &\alpha_{\cdot}\in\{\epsilon_{\cdot},\lambda_{\cdot} z\}\;\;\;f\\
x\tto y &\equiv y\tto x & g
\end{flalign*}
And we also extend it into $\cong$ by allowing $\alpha,\beta$ to be action prefixes in rules $c,d$:\\
$\alpha_\cdot,\beta_\cdot \in \{\epsilon_\cdot,\lambda_\cdot z,u_\cdot(t),\bar{u}_\cdot\langle v\rangle\}$;\\
as well as in rule $f$:\\
$\alpha_\cdot \in \{\epsilon_\cdot,\lambda_\cdot z,v_\cdot(t),\bar{v}_\cdot\langle w\rangle, u\neq v, u\neq t,u\neq w\}$.
\end{definition}

As said before, the first property we would like to have is the confluence of our arrows, that act as reduction rules in our annotated system. That is done for each one up to the corresponding equivalence defined above.
\begin{proposition}
Relation $\to$ is confluent up to $\equiv$, and relation $\leadsto$ is confluent up to $\cong$
\end{proposition}

\begin{myproof}
Most cases are treated in the $\to$ rule with $\equiv$, and we can note that rules 1 through 4 interacting with any rule means that one of the rules is a sub-term of the other. That means that, should we choose to reduce the inner rule first, we only replace the subterm in question with the result of the innermost rule, and should we choose to reduce the outer rule first, the innermost rule can still be applied in the subterm that has not been touched (worst case scenario would be a substitution in this term, but that does not affect the application of the rule). Cases where both choices lead to non-strictly equal terms are rules 5 and 6 interacting with themselves or each other. We detail them below:\\
Rule 5 against rule 5: there are 4 cases, depending on where the variable cut against is situated. The variable is noted as an exponent in the terms where it appears:\\
\begin{tikzcd}
& (P^y|_xQ)||_y(R^y|_zS)\arrow{dl}{5a,\;left}\arrow{dr}{5a,\;right} &\\
(P^y||_y(R^y|_zS))|_xQ\arrow{d}{5a} & & ((P^y|_xQ)||_yR^y)|_zS\arrow{d}{5a}\\
((P^y||_yR^y)|_zS)|_xQ & \equiv_{a_1} & ((P^y||_yR^y)|_xQ)|_zS
\end{tikzcd}\\
\begin{tikzcd}
& (P^y|_xQ)||_y(R|_zS^y)\arrow{dl}{5a,\;left}\arrow{dr}{5b,\;right} &\\
(P^y||_y(R|_zS^S))|_xQ\arrow{d}{5b} & & R|_z((P^y|_xQ)||_yS^y)\arrow{d}{5a}\\
(R|_z(P^y||_yS^y))|_xQ & \equiv_{b} & R|_z((P^y||_yS^y)|_xQ)
\end{tikzcd}\\
\begin{tikzcd}
& (P|_xQ^y)||_y(R^y|_zS)\arrow{dl}{5b,\;left}\arrow{dr}{5a,\;right} &\\
P|_x(Q^y||_y(R^y|_zS))\arrow{d}{5a} & & ((P|_xQ^y)||_yR^y)|_zS\arrow{d}{5b}\\
P|_x((Q^y||_yR^y)|_zS) & \equiv_{b} & (P|_x(Q^y||_yR^y))|_zS
\end{tikzcd}\\
\begin{tikzcd}
& (P|_xQ^y)||_y(R|_zS^y)\arrow{dl}{5b,\;left}\arrow{dr}{5b,\;right} &\\
P|_x(Q^y||_y(R|_zS^y))\arrow{d}{5b} & & R|_z(P|_xQ^y)||_yS)\arrow{d}{5b}\\
P|_x(R|_z(Q^y||_yS^y)) & \equiv_{a_2} & R|_z(P|_x(Q^y||_yS^y))
\end{tikzcd}\\~\\
Rule 6 against rule 6 works the same, here is an example with $\epsilon$ and $\nu$:\\
\begin{tikzcd}
& \epsilon_x.P ||_y (\nu u) Q \arrow{dl}{6a}\arrow{dr}{6c} &\\
\epsilon_x.(P ||_y (\nu u) Q)\arrow{d}{6c} & & (\nu u)(\epsilon_x.P ||_y Q)\arrow{d}{6a}\\
\epsilon_x.(\nu u)(P||_yQ) & \equiv_{f} & (\nu u)\epsilon_x.(P||_yQ)
\end{tikzcd}\\~\\
Other cases in the possible 6 against 6 rules are treated in the exact same manner. The last set of cases is a rule 5 against a rule 6. Those are all treated the same way as well, so we only treat two examples (one for $5a$ and one for $5b$):\\
\begin{tikzcd}
& (P^y |_x Q) ||_y (\nu u) R \arrow{dl}{5a}\arrow{dr}{6c} &\\
(P^y ||_y (\nu u) R)|_x Q\arrow{d}{6c} & & (\nu u)((P^y|_xQ) ||_y R)\arrow{d}{5a}\\
(\nu u)(P^y ||_y R) |_x Q & \equiv_{e} & (\nu u)((P^y ||_y R) |_x Q)
\end{tikzcd}\\
\begin{tikzcd}
& (P |_x Q^y) ||_y (\nu u) R \arrow{dl}{5b}\arrow{dr}{6c} &\\
P |_x (Q^y ||_y (\nu u) R)\arrow{d}{6c} & & (\nu u)((P |_x Q^y) ||_y R)\arrow{d}{5b}\\
P |_x (\nu u)(Q^y ||_y R) & \equiv_{e} & (\nu u)(P|_x (Q^y ||_y R))
\end{tikzcd}\\~\\
The specific cases added by $\leadsto$ are treated the exact same way, and are confluent with $\cong$.
\end{myproof}