\section{Definitions}

We first need to define the language of terms of our annotated $\pi$-calculus.
\begin{definition}
Take two countable sets, $N:=\{t,u,v,\ldots\}$ the set of names and $V:=\{x,y,z,\ldots\}$ the set of variables.\\
The annotated terms are defined by the following grammar:
\begin{flalign*}P,Q::= & x\tto y\;\; ; \;\; 0_x\;\; ; &x,y\in V\;\;\;\text{base terms}&\\
& \epsilon_x.P\;\; ; \;\; \lambda_xy.P\;\; ; &x,y\in V\;\;\;\text{variable introduction and modality prefixes}&\\
& u_x(t).P\;\; ; \;\; \bar{u}_x\langle v\rangle.P\;\; ; &t,u,v\in N,x\in V\;\;\;\text{action prefixes}&\\
& P |_x Q\;\; ; \;\; P ||_x Q \;\; ; &x\in V\;\;\;\text{parallel and synchronization}&\\
& (\nu u) P &u\in N\;\;\;\text{name binding prefix}&
\end{flalign*}
\end{definition}

The synchronization rule will be used to guide the behavior of terms, thus we define a reduction system over this construction specifically, as follows:
\begin{definition}
\label{reduction}
We define a reduction rule for synchronization (that does not hold under action prefixes) as follows:
\begin{flalign*}
\epsilon_x.P||_x 0_x &\to P &\text{symmetric in }||\;\;\;1\\
P||_x x\tto y &\to P[y/x] &\text{symmetric in }||\;\;\;2\\
(P|_xQ)||_x \lambda_xy.R &\to P||_x (Q[y/x] ||_y R) &3a\\
\lambda_xy.R ||_x (P|_xQ) &\to (R||_xP)||_y Q[y/x] &3b\\
\bar{u}_x\langle v \rangle.P||_x u_x(t).Q &\to P ||_x Q[v/t] &\text{symmetric in }||\;\;\;4
\end{flalign*}
We also define rules for commuting the synchronization with other rules, at first not holding under action prefixes:
\begin{flalign*}
(P|_xQ)||_yR &\geq (P||_yR)|_xQ &\text{symmetric in $||$, }y\not\in fv(Q)\;\;\;5a\\
(P|_xQ)||_yR &\geq P|_x(Q||_yR) &\text{symmetric in $||$, }y\not\in fv(P)\;\;\;5b\\
\epsilon_x.P||_yQ &\geq \epsilon_x.(P||_yQ) &\text{symmetric in $||$}\;\;\;6a\\
\lambda_xy.P||_zQ &\geq \lambda_xy.(P||_zQ) &\text{symmetric in $||$, }y\not\in fv(Q)\;\;\;6b\\
(\nu u)P ||_x Q &\geq (\nu u)(P||_xQ) &\text{symmetric in $||$, }u\not\in fn(Q)\;\;\;6c
\end{flalign*}
And we extend it into $\gtrsim$ as follows, allowing for it to act on (and under) action prefixes:
\begin{flalign*}
u_x(t).P||_yQ &\gtrsim u_x(t).(P||_yQ) &\text{symmetric in }||\;\;\;6d\\
\bar{u}_x\langle v \rangle.P||_yQ &\gtrsim \bar{u}_x\langle v \rangle.(P||_yQ) &\text{symmetric in }||\;\;\;6e
\end{flalign*}
Relation $\to$ is also extended into $\leadsto$ by allowing it to act under action prefixes (no specific rule added).
\end{definition}

%TODO - Remark about rule 5 (and some rules in 6) : if cut var. in too many terms, commutation is blocked.
%TODO - Examples to this remark: take main example for later parts 2 and 3, once with good constraints, and once without them (change some variables to be the same)\sim

We would like these arrows to have a confluent behavior. For that, we need equivalences, that we will define below.
\newpage

\begin{definition}
We define a congruence rule, that does not act on action prefixes:
\begin{flalign*}
(P|_xQ)|_yR &\equiv (P|_yR)|_xQ &y\not\in fv(Q), x\not\in fv(R)\;\;\;a_1\\
P|_x(Q|_yR) &\equiv Q|_y(P|_xR) &y\not\in fv(P), x\not\in fv(Q)\;\;\;a_2\\
(P|_xQ)|_yR &\equiv P|_x(Q|_yR) &y\not\in fv(P), x\not\in fv(R)\;\;\;b\\
P|_x \alpha_y.Q &\equiv \alpha_y.(P|_xQ) &\text{symmetric in }|, \alpha_{\cdot}\in\{\epsilon_{\cdot},\lambda_{\cdot} z\}, y,t\not\in fv(P)\;\;\;c\\
\alpha_x.\beta_y.P &\equiv \beta_y.\alpha_x.P &\alpha_{\cdot},\beta_{\cdot}\in\{\epsilon_{\cdot},\lambda_{\cdot} z\},x\neq y\;\;\;d\\
(\nu u) P |_x Q &\equiv (\nu u)(P |_x Q)&\text{symmetric in }|, u\not\in fn(Q)\;\;\;e\\
(\nu u)\alpha_x.P &\equiv \alpha_x.(\nu u)P &\alpha_{\cdot}\in\{\epsilon_{\cdot},\lambda_{\cdot} z\}\;\;\;f\\
x\tto y &\equiv y\tto x & g
\end{flalign*}
And we also extend it into $\cong$ by allowing $\alpha,\beta$ to be action prefixes in rules $c,d$:
\[\alpha_\cdot,\beta_\cdot \in \{\epsilon_\cdot,\lambda_\cdot z,u_\cdot(t),\bar{u}_\cdot\langle v\rangle\};\]
as well as in rule $f$:
\[\alpha_\cdot \in \{\epsilon_\cdot,\lambda_\cdot z,v_\cdot(t),\bar{v}_\cdot\langle w\rangle, u\neq v, u\neq t,u\neq w\}.\]
\end{definition}

As said before, the first property we would like to have is the confluence of our arrows, that act as reduction rules in our annotated system. That is done for each one up to the corresponding equivalence defined above.
\begin{proposition}
%TODO Change things here
\textcolor{red}{Changes to go here: $\to$ is strictly confluent, $\geq$ is confluent up to $\equiv$ and is a simulation for $\to$. Maybe 2 different propositions? Also rewrite the proof to go with the new propositions.}\\
Relation $\to$ is confluent up to $\equiv$, and relation $\leadsto$ is confluent up to $\cong$
\end{proposition}

\begin{myproof}
Most cases are treated in the $\to$ rule with $\equiv$, and we can note that rules 1 through 4 interacting with any rule means that one of the rules is a sub-term of the other. That means that, should we choose to reduce the inner rule first, we only replace the subterm in question with the result of the innermost rule, and should we choose to reduce the outer rule first, the innermost rule can still be applied in the subterm that has not been touched (worst case scenario would be a substitution in this term, but that does not affect the application of the rule). Cases where both choices lead to non-strictly equal terms are rules 5 and 6 interacting with themselves or each other. We detail them below:\\
Rule 5 against rule 5: there are 4 cases, depending on where the variable cut against is situated. The variable is noted as an exponent in the terms where it appears, and only 2 cases are treated (as the other two are their complements, and are treated the same):\\
\begin{tikzcd}[column sep=tiny, arrows=dashrightarrow]
& (P^y|_xQ)||_y(R^y|_zS)\arrow{dl}{\geq_{5a},\;left}\arrow{dr}{\geq_{5a},\;right} &\\
(P^y||_y(R^y|_zS))|_xQ\arrow{d}{\geq_{5a}} & & ((P^y|_xQ)||_yR^y)|_zS\arrow{d}{\geq_{5a}}\\
((P^y||_yR^y)|_zS)|_xQ & \equiv_{a_1} & ((P^y||_yR^y)|_xQ)|_zS
\end{tikzcd}\\
\begin{tikzcd}[column sep=tiny, arrows=dashrightarrow]
& (P^y|_xQ)||_y(R|_zS^y)\arrow{dl}{\geq_{5a},\;left}\arrow{dr}{\geq_{5b},\;right} &\\
(P^y||_y(R|_zS^S))|_xQ\arrow{d}{\geq_{5b}} & & R|_z((P^y|_xQ)||_yS^y)\arrow{d}{\geq_{5a}}\\
(R|_z(P^y||_yS^y))|_xQ & \equiv_{b} & R|_z((P^y||_yS^y)|_xQ)
\end{tikzcd}\\
Rule 6 against rule 6 works the same, here is an example with $\epsilon$ and $\nu$:\\
\begin{tikzcd}[column sep=tiny, arrows=dashrightarrow]
& \epsilon_x.P ||_y (\nu u) Q \arrow{dl}{\geq_{6a}}\arrow{dr}{\geq_{6c}} &\\
\epsilon_x.(P ||_y (\nu u) Q)\arrow{d}{\geq_{6c}} & & (\nu u)(\epsilon_x.P ||_y Q)\arrow{d}{\geq_{6a}}\\
\epsilon_x.(\nu u)(P||_yQ) & \equiv_{f} & (\nu u)\epsilon_x.(P||_yQ)
\end{tikzcd}\\~\\
Other cases in the possible 6 against 6 rules are treated in the exact same manner. The last set of cases is a rule 5 against a rule 6. Those are all treated the same way as well, so we only treat two examples (one for $5a$ and one for $5b$):\\
\begin{tikzcd}[column sep=tiny, arrows=dashrightarrow]
& (P^y |_x Q) ||_y (\nu u) R \arrow{dl}{\geq_{5a}}\arrow{dr}{\geq_{6c}} &\\
(P^y ||_y (\nu u) R)|_x Q\arrow{d}{\geq_{6c}} & & (\nu u)((P^y|_xQ) ||_y R)\arrow{d}{\geq_{5a}}\\
(\nu u)(P^y ||_y R) |_x Q & \equiv_{e} & (\nu u)((P^y ||_y R) |_x Q)
\end{tikzcd}\\
\begin{tikzcd}[column sep=tiny, arrows=dashrightarrow]
& (P |_x Q^y) ||_y (\nu u) R \arrow{dl}{\geq_{5b}}\arrow{dr}{\geq_{6c}} &\\
P |_x (Q^y ||_y (\nu u) R)\arrow{d}{\geq_{6c}} & & (\nu u)((P |_x Q^y) ||_y R)\arrow{d}{\geq_{5b}}\\
P |_x (\nu u)(Q^y ||_y R) & \equiv_{e} & (\nu u)(P|_x (Q^y ||_y R))
\end{tikzcd}\\~\\
The specific cases added by $\leadsto$ and $\gtrsim$ are treated the exact same way, and are confluent with $\cong$.
\end{myproof}

\textcolor{red}{Below maybe not needed after above rewrite}\\~\\
We also need to be sure the equivalence does not change the reduction, \ie that two equivalent terms have the same reductions. That is assured by showing the equivalence is a bisimulation relation.\\
\textcolor{red}{DO WE NEED TO REMIND THE DEFINITION OF A (BI)SIMULATION HERE?}\\
%TODO bisimulation definition?
\begin{proposition}
Relation $\equiv$ is a bisimulation for reduction $\geq^?\to\geq^*$.
\end{proposition}